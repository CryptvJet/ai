<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microphone Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; }
        #output { margin: 20px 0; padding: 10px; border: 1px solid #ddd; min-height: 100px; }
        .listening { background-color: #ff6b6b !important; }
    </style>
</head>
<body>
    <h1>Microphone & Voice Recognition Test</h1>
    
    <div id="browserCheck" class="status info">
        Checking browser compatibility...
    </div>
    
    <div id="permissionCheck" class="status info">
        Checking microphone permissions...
    </div>
    
    <div>
        <button id="testBtn" onclick="testMicrophone()">üé§ Test Microphone</button>
        <button id="stopBtn" onclick="stopTest()" disabled>‚èπÔ∏è Stop</button>
        <button id="clearBtn" onclick="clearOutput()">üóëÔ∏è Clear</button>
    </div>
    
    <div id="status" class="status info">
        Ready to test
    </div>
    
    <h3>Voice Recognition Output:</h3>
    <div id="output"></div>
    
    <h3>Debug Log:</h3>
    <div id="log"></div>

    <script>
        let recognition = null;
        let isListening = false;
        
        // Check browser compatibility
        function checkBrowserSupport() {
            const browserCheck = document.getElementById('browserCheck');
            
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                browserCheck.className = 'status success';
                browserCheck.textContent = '‚úì Browser supports Web Speech API';
                return true;
            } else {
                browserCheck.className = 'status error';
                browserCheck.textContent = '‚úó Browser does not support Web Speech API (Chrome/Edge required)';
                return false;
            }
        }
        
        // Check microphone permissions
        async function checkPermissions() {
            const permissionCheck = document.getElementById('permissionCheck');
            
            try {
                if (navigator.permissions) {
                    const result = await navigator.permissions.query({ name: 'microphone' });
                    
                    if (result.state === 'granted') {
                        permissionCheck.className = 'status success';
                        permissionCheck.textContent = '‚úì Microphone permission granted';
                    } else if (result.state === 'denied') {
                        permissionCheck.className = 'status error';
                        permissionCheck.textContent = '‚úó Microphone permission denied';
                    } else {
                        permissionCheck.className = 'status info';
                        permissionCheck.textContent = '? Microphone permission not yet requested';
                    }
                } else {
                    permissionCheck.className = 'status info';
                    permissionCheck.textContent = '? Cannot check permissions (may need HTTPS)';
                }
            } catch (error) {
                permissionCheck.className = 'status error';
                permissionCheck.textContent = '‚úó Error checking permissions: ' + error.message;
            }
        }
        
        // Initialize speech recognition
        function initSpeechRecognition() {
            if (!checkBrowserSupport()) return null;
            
            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 3;
                
                recognition.onstart = () => {
                    log('Speech recognition started');
                    isListening = true;
                    updateStatus('üé§ Listening... Speak now!', 'info');
                    document.getElementById('testBtn').classList.add('listening');
                    document.getElementById('testBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                };
                
                recognition.onend = () => {
                    log('Speech recognition ended');
                    isListening = false;
                    updateStatus('Voice recognition stopped', 'info');
                    document.getElementById('testBtn').classList.remove('listening');
                    document.getElementById('testBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                };
                
                recognition.onresult = (event) => {
                    let finalTranscript = '';
                    let interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    const output = document.getElementById('output');
                    
                    if (finalTranscript) {
                        output.innerHTML += '<div><strong>Final:</strong> ' + finalTranscript + '</div>';
                        log('Final transcript: ' + finalTranscript);
                    }
                    
                    if (interimTranscript) {
                        // Update the last interim result
                        let interimDiv = document.getElementById('interim');
                        if (!interimDiv) {
                            interimDiv = document.createElement('div');
                            interimDiv.id = 'interim';
                            interimDiv.style.color = '#666';
                            interimDiv.style.fontStyle = 'italic';
                            output.appendChild(interimDiv);
                        }
                        interimDiv.innerHTML = '<strong>Interim:</strong> ' + interimTranscript;
                    }
                    
                    // Scroll to bottom
                    output.scrollTop = output.scrollHeight;
                };
                
                recognition.onerror = (event) => {
                    log('Speech recognition error: ' + event.error);
                    let errorMsg = 'Unknown error';
                    
                    switch (event.error) {
                        case 'not-allowed':
                            errorMsg = 'Microphone access denied. Please allow microphone permissions.';
                            break;
                        case 'network':
                            errorMsg = 'Network error. Check your internet connection.';
                            break;
                        case 'no-speech':
                            errorMsg = 'No speech detected. Try speaking louder.';
                            break;
                        case 'audio-capture':
                            errorMsg = 'Audio capture error. Check your microphone.';
                            break;
                        case 'service-not-allowed':
                            errorMsg = 'Speech service not allowed. Try using HTTPS.';
                            break;
                        default:
                            errorMsg = 'Speech recognition error: ' + event.error;
                    }
                    
                    updateStatus('‚ùå ' + errorMsg, 'error');
                };
                
                return recognition;
                
            } catch (error) {
                log('Failed to initialize speech recognition: ' + error.message);
                updateStatus('Failed to initialize: ' + error.message, 'error');
                return null;
            }
        }
        
        function testMicrophone() {
            if (!recognition) {
                recognition = initSpeechRecognition();
            }
            
            if (!recognition) {
                updateStatus('Cannot start - speech recognition not available', 'error');
                return;
            }
            
            if (isListening) {
                log('Already listening, ignoring start request');
                return;
            }
            
            try {
                log('Attempting to start speech recognition...');
                recognition.start();
            } catch (error) {
                log('Error starting recognition: ' + error.message);
                updateStatus('Error starting: ' + error.message, 'error');
                
                if (error.name === 'InvalidStateError') {
                    log('Recognition already running, stopping first...');
                    recognition.stop();
                    setTimeout(() => {
                        recognition.start();
                    }, 100);
                }
            }
        }
        
        function stopTest() {
            if (recognition && isListening) {
                log('Stopping speech recognition...');
                recognition.stop();
            }
        }
        
        function clearOutput() {
            document.getElementById('output').innerHTML = '';
            document.getElementById('log').innerHTML = '';
        }
        
        function updateStatus(message, type) {
            const status = document.getElementById('status');
            status.className = 'status ' + type;
            status.textContent = message;
        }
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += '<div>[' + timestamp + '] ' + message + '</div>';
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // Initialize on page load
        window.onload = function() {
            checkBrowserSupport();
            checkPermissions();
        };
    </script>
</body>
</html>