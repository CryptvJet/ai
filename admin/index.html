<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Admin Panel</title>
    <link rel="stylesheet" href="../css/admin.css">
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <h1>üõ†Ô∏è AI Admin Panel</h1>
            <div class="header-actions">
                <button onclick="location.href='../index.html'" class="btn-back">‚Üê Back to Chat</button>
                <button onclick="saveAllSettings()" class="btn-save">üíæ Save All</button>
                <button onclick="logout()" class="btn-logout">üö™ Logout</button>
            </div>
        </header>

        <nav class="admin-nav">
            <button class="nav-btn active" onclick="showSection('identity')">ü§ñ Identity</button>
            <button class="nav-btn" onclick="showSection('responses')">üí¨ Responses</button>
            <button class="nav-btn" onclick="showSection('conversations')">üìä Conversations</button>
            <button class="nav-btn" onclick="showSection('integrations')">üîó Integrations</button>
            <button class="nav-btn" onclick="showSection('learning')">üß† Learning</button>
        </nav>

        <main class="admin-content">
            <!-- Identity Section -->
            <section id="identity" class="admin-section active">
                <h2>AI Identity & Personality</h2>
                
                <div class="form-group">
                    <label for="aiName">AI Name:</label>
                    <input type="text" id="aiName" value="ai" placeholder="Current AI name">
                    <small>The AI can suggest its own name based on conversations</small>
                </div>

                <div class="form-group">
                    <label for="personality">Personality Traits:</label>
                    <textarea id="personality" rows="3" placeholder="helpful,analytical,curious,friendly">helpful,analytical,curious</textarea>
                    <small>Comma-separated personality traits</small>
                </div>

                <div class="form-group">
                    <label for="responseStyle">Response Style:</label>
                    <select id="responseStyle">
                        <option value="conversational">Conversational</option>
                        <option value="formal">Formal</option>
                        <option value="casual">Casual</option>
                        <option value="technical">Technical</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="systemPrompt">System Prompt:</label>
                    <textarea id="systemPrompt" rows="5" placeholder="Base instructions for the AI...">You are an AI assistant specialized in analyzing PulseCore simulations and helping with data analysis. You have access to nova events, pattern data, and variables calculations.</textarea>
                </div>
            </section>

            <!-- Responses Section -->
            <section id="responses" class="admin-section">
                <h2>Response Templates</h2>
                
                <div class="responses-controls">
                    <button onclick="addNewTemplate()" class="btn-primary">+ Add Template</button>
                    <button onclick="importTemplates()" class="btn-secondary">üì• Import</button>
                    <button onclick="exportTemplates()" class="btn-secondary">üì§ Export</button>
                </div>

                <div class="templates-container" id="templatesContainer">
                    <!-- Response templates will be loaded here -->
                </div>
            </section>

            <!-- Conversations Section -->
            <section id="conversations" class="admin-section">
                <h2>Conversation Analytics</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Conversations</h3>
                        <div class="stat-value" id="totalConversations">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Messages</h3>
                        <div class="stat-value" id="totalMessages">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Avg. Response Time</h3>
                        <div class="stat-value" id="avgResponseTime">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>Success Rate</h3>
                        <div class="stat-value" id="successRate">-</div>
                    </div>
                </div>

                <div class="conversations-table">
                    <h3>Recent Conversations</h3>
                    <table id="conversationsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Started</th>
                                <th>Messages</th>
                                <th>Duration</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Conversations will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Integrations Section -->
            <section id="integrations" class="admin-section">
                <h2>Database Integrations</h2>
                
                <div class="integration-grid">
                    <div class="integration-card">
                        <h3>üåä PulseCore</h3>
                        <div class="integration-status" id="pulsecoreStatus">
                            <span class="status-indicator"></span>
                            <span class="status-text">Checking...</span>
                        </div>
                        <div class="integration-stats">
                            <p>Nova Events: <span id="novaCount">-</span></p>
                            <p>Climax Groups: <span id="climaxCount">-</span></p>
                            <p>Last Update: <span id="lastNovaTime">-</span></p>
                        </div>
                        <button onclick="testPulseCoreConnection()" class="btn-test">Test Connection</button>
                    </div>

                    <div class="integration-card">
                        <h3>üìä Variables</h3>
                        <div class="integration-status" id="variablesStatus">
                            <span class="status-indicator"></span>
                            <span class="status-text">Checking...</span>
                        </div>
                        <div class="integration-stats">
                            <p>Variables: <span id="variableCount">-</span></p>
                            <p>Calculations: <span id="calculationCount">-</span></p>
                            <p>Last Update: <span id="lastVarTime">-</span></p>
                        </div>
                        <button onclick="testVariablesConnection()" class="btn-test">Test Connection</button>
                    </div>

                    <div class="integration-card">
                        <h3>üñ•Ô∏è PC AI Server</h3>
                        <div class="integration-status" id="pcaiStatus">
                            <span class="status-indicator"></span>
                            <span class="status-text">Checking...</span>
                        </div>
                        <div class="integration-stats">
                            <p>Model: <span id="currentModel">-</span></p>
                            <p>GPU Memory: <span id="gpuMemory">-</span></p>
                            <p>Response Time: <span id="pcResponseTime">-</span></p>
                        </div>
                        <button onclick="testPCAIConnection()" class="btn-test">Test Connection</button>
                    </div>
                </div>
            </section>

            <!-- Learning Section -->
            <section id="learning" class="admin-section">
                <h2>AI Learning & Patterns</h2>
                
                <div class="learning-controls">
                    <label class="toggle-switch">
                        <input type="checkbox" id="learningEnabled" checked>
                        <span class="toggle-slider"></span>
                        Enable Learning from Conversations
                    </label>
                </div>

                <div class="learning-stats">
                    <h3>Learned Patterns</h3>
                    <div class="patterns-container" id="patternsContainer">
                        <!-- Learned patterns will be displayed here -->
                    </div>
                </div>

                <div class="learning-actions">
                    <button onclick="analyzeConversations()" class="btn-primary">üîç Analyze Conversations</button>
                    <button onclick="clearLearningData()" class="btn-danger">üóëÔ∏è Clear Learning Data</button>
                    <button onclick="exportLearningData()" class="btn-secondary">üì§ Export Patterns</button>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Check authentication before loading admin
        async function checkAuth() {
            const token = localStorage.getItem('admin_token');
            const expires = localStorage.getItem('admin_expires');
            
            console.log('Checking auth - Token exists:', !!token, 'Expires:', expires);
            
            // Check if token exists and hasn't expired
            if (!token || !expires || Date.now() > parseInt(expires)) {
                console.log('No valid local token, redirecting to login');
                window.location.href = 'login.html';
                return false;
            }
            
            console.log('Local token valid, checking with server...');
            
            // Try to validate token with server, but don't fail if server is down
            try {
                const response = await fetch('../api/validate-session.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ token: token })
                });
                
                const result = await response.json();
                console.log('Server validation result:', result);
                
                if (!result.success) {
                    console.log('Server says session invalid, redirecting to login');
                    localStorage.removeItem('admin_token');
                    localStorage.removeItem('admin_expires');
                    window.location.href = 'login.html';
                    return false;
                }
                
                console.log('Server validation successful');
                return true;
            } catch (error) {
                console.warn('Server validation failed (this is expected with API issues):', error);
                
                // If server validation fails but token hasn't expired locally, allow access
                const locallyValid = Date.now() < parseInt(expires);
                console.log('Using local token validation:', locallyValid);
                
                if (locallyValid) {
                    // Show a warning that we're in offline mode
                    showOfflineWarning();
                }
                
                return locallyValid;
            }
        }
        
        function showOfflineWarning() {
            const warning = document.createElement('div');
            warning.id = 'offlineWarning';
            warning.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: rgba(255, 193, 7, 0.9);
                color: #000;
                padding: 10px 15px;
                border-radius: 8px;
                font-weight: bold;
                z-index: 1000;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            warning.innerHTML = '‚ö†Ô∏è Admin panel running in offline mode (API unavailable)';
            document.body.appendChild(warning);
            
            // Remove after 5 seconds
            setTimeout(() => {
                if (document.getElementById('offlineWarning')) {
                    warning.remove();
                }
            }, 5000);
        }
        
        // Add logout function
        async function logout() {
            const token = localStorage.getItem('admin_token');
            
            // Call logout API
            try {
                await fetch('../api/logout.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token })
                });
            } catch (error) {
                console.error('Logout API failed:', error);
            }
            
            // Clear local storage
            localStorage.removeItem('admin_token');
            localStorage.removeItem('admin_expires');
            
            // Redirect to login
            window.location.href = 'login.html';
        }
        
        // Check auth on page load
        checkAuth().then(isAuthenticated => {
            if (isAuthenticated) {
                // Load admin script
                const script = document.createElement('script');
                script.src = '../js/admin.js';
                document.body.appendChild(script);
            }
        });
    </script>
</body>
</html>