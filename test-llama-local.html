<!DOCTYPE html>
<html>
<head>
    <title>Local Llama Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1b2e;
            color: #e2e8f0;
        }
        .status-section {
            background: rgba(30, 41, 59, 0.8);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .status-online { color: #10b981; }
        .status-offline { color: #ef4444; }
        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            transform: translateY(-1px);
        }
        #chat-container {
            background: rgba(30, 41, 59, 0.8);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .user-message {
            background: rgba(59, 130, 246, 0.2);
            text-align: right;
        }
        .ai-message {
            background: rgba(139, 92, 246, 0.2);
        }
        input[type="text"] {
            width: 70%;
            padding: 10px;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: 5px;
            color: #e2e8f0;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <h1>üß† Local Llama Integration Test</h1>
    
    <div class="status-section">
        <h3>Connection Status</h3>
        <div id="status-display">
            <div>Ollama Server: <span id="ollama-status" class="status-offline">Unknown</span></div>
            <div>Available Models: <span id="model-list">-</span></div>
            <div>Selected Model: <span id="selected-model">-</span></div>
        </div>
        <br>
        <button onclick="checkStatus()">üîÑ Check Status</button>
        <button onclick="testModel()">üß™ Test Model</button>
    </div>

    <div class="status-section">
        <h3>API Tests</h3>
        <button onclick="testLlamaAPI()">Test Local Llama API</button>
        <button onclick="testChatAPI()">Test Main Chat API</button>
        <div id="test-results" style="margin-top: 10px;"></div>
    </div>

    <div id="chat-container">
        <h3>Live Chat Test</h3>
        <div id="chat-messages"></div>
        <input type="text" id="message-input" placeholder="Type a message..." onkeypress="if(event.key=='Enter') sendMessage()">
        <button onclick="sendMessage()">Send</button>
    </div>

    <script>
        async function checkStatus() {
            try {
                const response = await fetch('api/llama-local.php?action=status');
                const data = await response.json();
                
                const statusEl = document.getElementById('ollama-status');
                const modelListEl = document.getElementById('model-list');
                const selectedModelEl = document.getElementById('selected-model');
                
                if (data.status === 'online') {
                    statusEl.textContent = 'Online ‚úÖ';
                    statusEl.className = 'status-online';
                    modelListEl.textContent = data.available_models?.join(', ') || 'None';
                    selectedModelEl.textContent = data.selected_model || 'None';
                } else {
                    statusEl.textContent = 'Offline ‚ùå';
                    statusEl.className = 'status-offline';
                    modelListEl.textContent = 'N/A';
                    selectedModelEl.textContent = 'N/A';
                }
                
                console.log('Status check result:', data);
            } catch (error) {
                console.error('Status check failed:', error);
                document.getElementById('ollama-status').textContent = 'Error ‚ùå';
            }
        }

        async function testModel() {
            try {
                const response = await fetch('api/llama-local.php?action=test');
                const data = await response.json();
                
                const results = document.getElementById('test-results');
                if (data.success) {
                    results.innerHTML = `<div style="color: #10b981;">‚úÖ Model Test Successful!</div>
                                       <div>Model: ${data.model}</div>
                                       <div>Response: ${data.response}</div>
                                       <div>Time: ${data.response_time_ms}ms</div>`;
                } else {
                    results.innerHTML = `<div style="color: #ef4444;">‚ùå Model Test Failed</div>
                                       <div>Error: ${data.error}</div>`;
                }
            } catch (error) {
                console.error('Model test failed:', error);
            }
        }

        async function testLlamaAPI() {
            const resultsEl = document.getElementById('test-results');
            resultsEl.innerHTML = '<div style="color: #f59e0b;">Testing Local Llama API...</div>';
            
            try {
                const response = await fetch('api/llama-local.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: "Hello! Please introduce yourself briefly.",
                        context: { mode: 'test' }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultsEl.innerHTML = `<div style="color: #10b981;">‚úÖ Local Llama API Test Successful!</div>
                                         <div><strong>Response:</strong> ${data.response}</div>
                                         <div><strong>Model:</strong> ${data.model || 'Unknown'}</div>`;
                } else {
                    resultsEl.innerHTML = `<div style="color: #ef4444;">‚ùå Local Llama API Test Failed</div>
                                         <div><strong>Error:</strong> ${data.error}</div>`;
                }
            } catch (error) {
                resultsEl.innerHTML = `<div style="color: #ef4444;">‚ùå API Request Failed</div>
                                     <div><strong>Error:</strong> ${error.message}</div>`;
            }
        }

        async function testChatAPI() {
            const resultsEl = document.getElementById('test-results');
            resultsEl.innerHTML = '<div style="color: #f59e0b;">Testing Main Chat API with Full Power Mode...</div>';
            
            try {
                const response = await fetch('api/chat.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: "Hello! Can you tell me about your capabilities?",
                        session_id: 'test_session_' + Date.now(),
                        mode: 'full-power'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultsEl.innerHTML = `<div style="color: #10b981;">‚úÖ Main Chat API Test Successful!</div>
                                         <div><strong>Response:</strong> ${data.response}</div>
                                         <div><strong>Mode:</strong> ${data.mode}</div>
                                         <div><strong>Processing Time:</strong> ${data.processing_time_ms}ms</div>`;
                } else {
                    resultsEl.innerHTML = `<div style="color: #ef4444;">‚ùå Main Chat API Test Failed</div>
                                         <div><strong>Error:</strong> ${data.error}</div>`;
                }
            } catch (error) {
                resultsEl.innerHTML = `<div style="color: #ef4444;">‚ùå Chat API Request Failed</div>
                                     <div><strong>Error:</strong> ${error.message}</div>`;
            }
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            if (!message) return;
            
            // Add user message to chat
            addChatMessage(message, 'user');
            input.value = '';
            
            // Send to chat API
            try {
                const response = await fetch('api/chat.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        session_id: 'test_chat_' + Date.now(),
                        mode: 'full-power'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addChatMessage(data.response, 'ai');
                } else {
                    addChatMessage('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                addChatMessage('Network Error: ' + error.message, 'error');
            }
        }

        function addChatMessage(message, type) {
            const messagesEl = document.getElementById('chat-messages');
            const messageEl = document.createElement('div');
            messageEl.className = type === 'user' ? 'message user-message' : 'message ai-message';
            if (type === 'error') messageEl.style.color = '#ef4444';
            messageEl.textContent = message;
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        // Run initial status check
        checkStatus();
    </script>
</body>
</html>